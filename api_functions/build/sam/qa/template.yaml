# This is the SAM template that represents the architecture of your serverless application
# https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-template-basics.html

# The AWSTemplateFormatVersion identifies the capabilities of the template
# https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/format-version-structure.html
AWSTemplateFormatVersion: '2010-09-09'
Description: >-
  api_functions
  
Globals:
  Function:
    Environment:
      Variables:
        ENV_NAME:
          Ref: EnvNameParameter
        AWS_SECRET_ID:
          Ref: PaveSecretIdParameter
        NODE_ENV:
          Ref: EnvNameParameter
        HTML_ALLOWED_TAGS: div|span|strong|sup|l|b|br|label|p|pre
        MAILGUN_DOMAIN: mail-dev.chaaat.io
        MAILGUN_API_KEY: a7aa2f2b1c47f5ba37b1ad55c2e18f01-e5da0167-1e6a4e3b
        LOG_TO_SENTRY: "true"
        PARTNER_PORTAL_URL: https://partner-api.unificationengine.com
        WEBHOOK_X_COMPONENT_SECRET: 5rO8pBwlI5ezBACN
        SUBSCRIPTION_TRIAL_PRICE: price_1PjCiGIz3ID7iG8q1pIsrxzP
        SUBSCRIPTION_BETA_USER_PRICE: price_1QGDZNIz3ID7iG8q1WmTSlO6
        SUBSCRIPTION_STARTER_PRICE: price_1PMNv0Iz3ID7iG8qrm7tGMKN
        SUBSCRIPTION_PRO_PRICE: price_1Pl5WXIz3ID7iG8qC9auDxa3

Parameters:
  EnvNameParameter:
    Type: String
  PaveSecretIdParameter:
    Type: String

# Transform section specifies one or more macros that AWS CloudFormation uses to process your template
# https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/transform-section-structure.html
Transform:
- AWS::Serverless-2016-10-31

# Resources declares the AWS resources that you want to include in the stack
# https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/resources-section-structure.html
Resources:  
  # This is the Lambda function definition associated with the source code: sqs-payload-logger.js. For all available properties, see
  # https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
  ChaaatHTTPAPI:
    Type: AWS::Serverless::HttpApi
    Properties:
      StageName: qa
  TransloaditOptimiseImages:
    Type: AWS::Serverless::Function
    Properties:
      Role: arn:aws:iam::004391475553:role/lambda-execution
      Description: A Lambda function that triggers execution of Transloadit's image optimisation assembly.
      Runtime: nodejs18.x
      Architectures:
        - x86_64
      Handler: src/handlers/transloadit-optimise-images.optimiseImages
      # This property associates this Lambda function with a scheduled CloudWatch Event. For all available properties, see
      # https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#schedule
      # This example runs every hour.
      Events:
        CloudWatchEvent:
          Type: Schedule
          Properties:
            Schedule: rate(2 hours)
            Name: transloadit-optimise-images
            Description: Transloadit - Optimise images assembly
            Enabled: True
      MemorySize: 128
      Timeout: 100
  ContactAssignmentNotif:
    Type: AWS::Serverless::Function
    Properties:
      Role: arn:aws:iam::004391475553:role/lambda-execution
      Description: A Lambda function that send assignment notifications to agents.
      Runtime: nodejs18.x
      Architectures:
        - x86_64
      Handler: src/handlers/contact-assignment-notif.sendNotif
      Events:
        CloudWatchEvent:
          Type: Schedule
          Properties:
            # This example runs every 1 minute
            Schedule: rate(3 minutes)
            Name: contact-assignment-notif-trigger
            Description: Contact Assignment trigger
            Enabled: True
      MemorySize: 500
      Timeout: 800

  EnquirySmsFollowup:
    Type: AWS::Serverless::Function
    Properties:
      Role: arn:aws:iam::004391475553:role/lambda-execution
      Description: A Lambda function that send sms followup to contacts who enquired.
      Runtime: nodejs18.x
      Architectures:
        - x86_64
      Handler: src/handlers/enquiry-sms-followup.sendSms
      Events:
        CloudWatchEvent:
          Type: Schedule
          Properties:
            # This example runs every friday at 17:00 UTC
            Schedule: cron(0 21 ? * 6 *)
            Name: enquiry-sms-followup-trigger
            Description: Enquiry SMS Followup Trigger
            Enabled: True
      MemorySize: 500
      Timeout: 800

  EnquiryEmail2:
    Type: AWS::Serverless::Function
    Properties:
      Role: arn:aws:iam::004391475553:role/lambda-execution
      Description: A Lambda function that send email 2 to contacts who enquired after 2nd Saturday.
      Runtime: nodejs18.x
      Architectures:
        - x86_64
      Handler: src/handlers/enquiry-email-2.sendEmail2
      Events:
        CloudWatchEvent:
          Type: Schedule
          Properties:
            # This example runs every thursday at 17:00 UTC
            Schedule: cron(0 21 ? * 5 *)
            Name: enquiry-email-2-trigger
            Description: Enquiry Email 2 Trigger
            Enabled: True
      MemorySize: 500
      Timeout: 800

  # SFCronTrigger:
  #   Type: AWS::Serverless::Function
  #   Properties:
  #     Role: arn:aws:iam::004391475553:role/lambda-execution
  #     Description: A Lambda function that will trigger Salesforce AMQ processor
  #     Runtime: nodejs18.x
  #     Architectures:
  #       - x86_64
  #     Handler: src/handlers/salesforce-cron.triggerCron
  #     Events:
  #       CloudWatchEvent:
  #         Type: Schedule
  #         Properties:
  #           Schedule: rate(2 minutes)
  #           Name: sf-cron-trigger
  #           Description: SF Cron Trigger
  #           Enabled: True
  #     MemorySize: 500
  #     Timeout: 800
  
  SendScheduledCampaign:
    Type: AWS::Serverless::Function
    Properties:
      Role: arn:aws:iam::004391475553:role/lambda-execution
      Description: A Lambda function that will trigger campaign sending based on source and schedule provided
      Runtime: nodejs18.x
      Architectures:
        - x86_64
      Handler: src/handlers/send-scheduled-campaign.sendCampaign
      Events:
        CloudWatchEvent:
          Type: Schedule
          Properties:
            Schedule: cron(0/15 * * * ? *)
            Name: send-scheduled-campaign
            Description: Send Scheduled Campaign
            Enabled: True
      MemorySize: 500
      Timeout: 800

  # GetWABAQualityAndStatus:
  #   Type: AWS::Serverless::Function
  #   Properties:
  #     Role: arn:aws:iam::004391475553:role/lambda-execution
  #     Description: A Lambda function that will get WABA quality and status
  #     Runtime: nodejs18.x
  #     Architectures:
  #       - x86_64
  #     Handler: src/handlers/waba-cron.getWABAQualityAndStatus
  #     Events:
  #       CloudWatchEvent:
  #         Type: Schedule
  #         Properties:
  #           Schedule: cron(1 * * * ? *)
  #           Name: waba-cron
  #           Description: Get WABA Quality And Status
  #           Enabled: True
  #     MemorySize: 500
  #     Timeout: 800
  
  FinishedCampaignNotification:
    Type: AWS::Serverless::Function
    Properties:
      Role: arn:aws:iam::004391475553:role/lambda-execution
      Description: A Lambda function that will send notification when campaign has ended
      Runtime: nodejs18.x
      Architectures:
        - x86_64
      Handler: src/handlers/finished-campaign-notification.sendNotification
      Events:
        CloudWatchEvent:
          Type: Schedule
          Properties:
            Schedule: cron(0/1 * * * ? *)
            Name: finished-campaign-notification
            Description: Send Finished Campaign Notification
            Enabled: True
      MemorySize: 500
      Timeout: 800

  # WhatsAppTemplateSync:
  #   Type: AWS::Serverless::Function
  #   Properties:
  #     Role: arn:aws:iam::004391475553:role/lambda-execution
  #     Description: A Lambda function that will sync waba templates
  #     Runtime: nodejs18.x
  #     Architectures:
  #       - x86_64
  #     Handler: src/handlers/whatsapp-template-sync.syncTemplates
  #     Events:
  #       CloudWatchEvent:
  #         Type: Schedule
  #         Properties:
  #           Schedule: cron(0/15 * * * ? *)
  #           Name: whatsapp-template-sync
  #           Description: WhatsApp Template Sync
  #           Enabled: True
  #     MemorySize: 500
  #     Timeout: 800
  
  MindBodySyncUpdatedPackages:
    Type: AWS::Serverless::Function
    Properties:
      Role: arn:aws:iam::004391475553:role/lambda-execution
      Description: A Lambda function that will sync updated mindbody packages
      Runtime: nodejs18.x
      Architectures:
        - x86_64
      Handler: src/handlers/mindbody-package-sync.syncUpdatedPackages
      Events:
        CloudWatchEvent:
          Type: Schedule
          Properties:
            Schedule: cron(0/5 * * * ? *)
            Name: mindbody-package-sync
            Description: Mindbody Updated Packages Sync
            Enabled: True
      MemorySize: 500
      Timeout: 800

  MindBodyAutomation:
    Type: AWS::Serverless::Function
    Properties:
      Role: arn:aws:iam::004391475553:role/lambda-execution
      Description: A Lambda function that will execute mindbody automation
      Runtime: nodejs18.x
      Architectures:
        - x86_64
      Handler: src/handlers/mindbody-automation.runAutomation
      Events:
        CloudWatchEvent:
          Type: Schedule
          Properties:
            Schedule: cron(0/5 * * * ? *)
            Name: mindbody-automation
            Description: Mindbody Automation
            Enabled: True
      MemorySize: 500
      Timeout: 800
    
  AppSyncCredentialsUpdate:
    Type: AWS::Serverless::Function
    Properties:
      Role: arn:aws:iam::004391475553:role/lambda-execution
      Description: A Lambda function that will execute mindbody automation
      Runtime: nodejs18.x
      Architectures:
        - x86_64
      Handler: src/handlers/appsync-credentials.updateCredentials
      Events:
        CloudWatchEvent:
          Type: Schedule
          Properties:
            Schedule: cron(0 0 1/360 * ? *)
            Name: appsync-credentials
            Description: AppSync Credentials
            Enabled: True
      MemorySize: 500
      Timeout: 800
  
  MindBodyDailyAutomation:
    Type: AWS::Serverless::Function
    Properties:
      Role: arn:aws:iam::004391475553:role/lambda-execution
      Description: A Lambda function that will execute a daily mindbody automation
      Runtime: nodejs18.x
      Architectures:
        - x86_64
      Handler: src/handlers/mindbody-daily-automation.dailyAutomation
      Events:
        CloudWatchEvent:
          Type: Schedule
          Properties:
            Schedule: cron(0 8 * * ? *)
            Name: mindbody-daily-automation
            Description: Mindbody Daily Automation
            Enabled: True
      MemorySize: 500
      Timeout: 800
  
  MindBodyAutomationWebhookCheck:
    Type: AWS::Serverless::Function
    Properties:
      Role: arn:aws:iam::004391475553:role/lambda-execution
      Description: A Lambda function that will execute mindbody automation webhook checking
      Runtime: nodejs18.x
      Architectures:
        - x86_64
      Handler: src/handlers/mindbody-automation-webhook-check.runAutomationWebhookCheck
      Events:
        CloudWatchEvent:
          Type: Schedule
          Properties:
            Schedule: cron(0 * * * ? *)
            Name: mindbody-automation-webhook-check
            Description: Mindbody Automation Webhook Check
            Enabled: True
      MemorySize: 500
      Timeout: 800

  HubSpotFormSync:
    Type: AWS::Serverless::Function
    Properties:
      Role: arn:aws:iam::004391475553:role/lambda-execution
      Description: A Lambda function that will sync agency hubspot form sync
      Runtime: nodejs18.x
      Architectures:
        - x86_64
      Handler: src/handlers/hubspot-form-sync.syncForms
      Events:
        CloudWatchEvent:
          Type: Schedule
          Properties:
            Schedule: cron(0/15 * * * ? *)
            Name: hubspot-form-sync
            Description: HubSpot Form Sync
            Enabled: True
      MemorySize: 500
      Timeout: 800
  
  SFCitiesSync:
    Type: AWS::Serverless::Function
    Properties:
      Role: arn:aws:iam::004391475553:role/lambda-execution
      Description: A Lambda function that will sync salesforce cities
      Runtime: nodejs18.x
      Architectures:
        - x86_64
      Handler: src/handlers/sf-cities-sync.sfCitiesSync
      Events:
        CloudWatchEvent:
          Type: Schedule
          Properties:
            Schedule: cron(0/1 * * * ? *)
            Name: sf-cities-sync
            Description: Salesforce Cities Sync
            Enabled: True
      MemorySize: 500
      Timeout: 800
  
  HubSpotAutomation:
    Type: AWS::Serverless::Function
    Properties:
      Role: arn:aws:iam::004391475553:role/lambda-execution
      Description: A Lambda function that will check if recipient responded to the initial automation in 24hrs
      Runtime: nodejs18.x
      Architectures:
        - x86_64
      Handler: src/handlers/hubspot-automation.runAutomationResponseCheck
      Events:
        CloudWatchEvent:
          Type: Schedule
          Properties:
            Schedule: cron(0 * * * ? *)
            Name: hubspot-automation
            Description: HubSpot Automation
            Enabled: True
      MemorySize: 500
      Timeout: 800

  AppointmentBookingReminder:
    Type: AWS::Serverless::Function
    Properties:
      Role: arn:aws:iam::004391475553:role/lambda-execution
      Description: A Lambda function that will send the appointment booking reminder
      Runtime: nodejs18.x
      Architectures:
        - x86_64
      Handler: src/handlers/appointment-booking-reminder.sendAppointmentBookingReminder
      Events:
        CloudWatchEvent:
          Type: Schedule
          Properties:
            Schedule: cron(0/1 * * * ? *)
            Name: appointment-booking-reminder
            Description: Send Appointment Booking Reminder
            Enabled: True
      MemorySize: 500
      Timeout: 800

  ReceiveMessageWebhook:
    Type: AWS::Serverless::Function
    Properties:
      Role: arn:aws:iam::004391475553:role/lambda-execution
      Description: A Lambda function that will receive Message Webhook Payload Data from UIB
      Runtime: nodejs18.x
      Architectures:
        - x86_64
      Handler: src/handlers/message-webhook.receivePayload
      Events:
        Api:
          Type: HttpApi
          Properties:
            Path: /message/webhook
            Method: post
            ApiId: !Ref ChaaatHTTPAPI
      MemorySize: 500
      Timeout: 800
  
  CheckSubscriptionContactAndOrMessageCapacityIf100:
    Type: AWS::Serverless::Function
    Properties:
      Role: arn:aws:iam::004391475553:role/lambda-execution
      Description: A Lambda function that will check if capacity is 100 for agency subscription contact and message
      Runtime: nodejs18.x
      Architectures:
        - x86_64
      Handler: src/handlers/check-full-contact-or-message-capacity-notification.checkSubscriptionContactOrMessageCapacity
      Events:
        CloudWatchEvent:
          Type: Schedule
          Properties:
            Schedule: cron(0 9 * * ? *)
            Name: check-full-contact-or-message-capacity-notification
            Description: Check Subscription Contact Or Message Capacity
            Enabled: True
      MemorySize: 500
      Timeout: 800
  
  CheckAgencyTrialSubscription:
    Type: AWS::Serverless::Function
    Properties:
      Role: arn:aws:iam::004391475553:role/lambda-execution
      Description: A Lambda function that will check an agency is on trial and is due in 1 day
      Runtime: nodejs18.x
      Architectures:
        - x86_64
      Handler: src/handlers/check-trial-subscription.checkAgencyTrialSubscription
      Events:
        CloudWatchEvent:
          Type: Schedule
          Properties:
            Schedule: cron(0 9 * * ? *)
            Name: check-trial-subscription
            Description: Check Trial Subscription To End Tomorrow
            Enabled: True
      MemorySize: 500
      Timeout: 800

  ReceiveStripeWebhook:
    Type: AWS::Serverless::Function
    Properties:
      Role: arn:aws:iam::004391475553:role/lambda-execution
      Description: A Lambda function that will receive Stripe Webhook Payload Data
      Runtime: nodejs18.x
      Architectures:
        - x86_64
      Handler: src/handlers/stripe-webhook.receivePayload
      Events:
        Api:
          Type: HttpApi
          Properties:
            Path: /stripe/webhook
            Method: post
            ApiId: !Ref ChaaatHTTPAPI
      MemorySize: 500
      Timeout: 800

  ReceiveWixWebhook:
    Type: AWS::Serverless::Function
    Properties:
      Role: arn:aws:iam::004391475553:role/lambda-execution
      Description: A Lambda function that will receive Wix Webhook Payload Data
      Runtime: nodejs18.x
      Architectures:
        - x86_64
      Handler: src/handlers/wix-webhook.receivePayload
      Events:
        Api:
          Type: HttpApi
          Properties:
            Path: /wix/webhook
            Method: post
            ApiId: !Ref ChaaatHTTPAPI
      MemorySize: 500
      Timeout: 800