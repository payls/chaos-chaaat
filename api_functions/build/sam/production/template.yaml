# This is the SAM template that represents the architecture of your serverless application
# https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-template-basics.html

# The AWSTemplateFormatVersion identifies the capabilities of the template
# https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/format-version-structure.html
AWSTemplateFormatVersion: '2010-09-09'
Description: >-
  api_functions
  
Globals:
  Function:
    Environment:
      Variables:
        ENV_NAME:
          Ref: EnvNameParameter
        AWS_SECRET_ID:
          Ref: PaveSecretIdParameter
        NODE_ENV:
          Ref: EnvNameParameter
        HTML_ALLOWED_TAGS: div|span|strong|sup|l|b|br|label|p|pre
        MAILGUN_DOMAIN: mail.chaaat.io
        MAILGUN_API_KEY: d7fa21cc478aba98407c87fc5b0b783c-835621cf-bf82374c
        SF_CRON_TRIGGER_QUEUE: 'IN.PROD.ALLPROCESS'
        SF_CRON_TRIGGER_EXCHANGE: 'IN.PROD.ALLPROCESS'
        APPOINTMENT_BOOKING_REMINDER_QUEUE: 'IN.PROD.ALLPROCESS'
        LOG_TO_SENTRY: "true"
        PARTNER_PORTAL_URL: https://partner-api.unificationengine.com
        WEBHOOK_X_COMPONENT_SECRET: 5rO8pBwlI5ezBACN
        SUBSCRIPTION_TRIAL_PRICE: price_1PvvmVIz3ID7iG8qS2I1lWoX
        SUBSCRIPTION_BETA_USER_PRICE: price_1QNnSKIz3ID7iG8qMeaL2Lzj
        SUBSCRIPTION_STARTER_PRICE: price_1PHGroIz3ID7iG8qvz9B7WQh
        SUBSCRIPTION_PRO_PRICE: price_1PHH0cIz3ID7iG8qZFCvXuvo
        DEALZ_STARTER_PRICE: price_1QrX3RRsHEujz4lEs7z5jbYn
        DEALZ_PRO_PRICE: price_1QrX3PRsHEujz4lEpcIBCshp
        DEALZ_BASIC_PRICE: price_1QsK6tRsHEujz4lEsduog4Xi
        DEALZ_BASIC_PRODUCT_ID: prod_Rl39zNrYqVb0IS
        DEALZ_STRIPE_SECRET_KEY: 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
        REDIS_CLUSTER_MODE: "true"
        REDIS_CLUSTER_HOST: chaaat-valkey-serverless-cluster-prd-upvvj6.serverless.apse1.cache.amazonaws.com
Parameters:
  EnvNameParameter:
    Type: String
  PaveSecretIdParameter:
    Type: String

# Transform section specifies one or more macros that AWS CloudFormation uses to process your template
# https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/transform-section-structure.html
Transform:
- AWS::Serverless-2016-10-31

# Resources declares the AWS resources that you want to include in the stack
# https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/resources-section-structure.html
Resources:  
  # This is the Lambda function definition associated with the source code: sqs-payload-logger.js. For all available properties, see
  # https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
  ChaaatHTTPAPI:
    Type: AWS::Serverless::HttpApi
    Properties:
      StageName: prd

  # SFCronTrigger:
  #   Type: AWS::Serverless::Function
  #   Properties:
  #     Role: arn:aws:iam::346909834191:role/lambda-execution
  #     Description: A Lambda function that will trigger Salesforce AMQ processor
  #     Runtime: nodejs18.x
  #     Architectures:
  #       - x86_64
  #     Handler: src/handlers/salesforce-cron.triggerCron
  #     Events:
  #       CloudWatchEvent:
  #         Type: Schedule
  #         Properties:
  #           Schedule: rate(2 minutes)
  #           Name: sf-cron-trigger
  #           Description: SF Cron Trigger
  #           Enabled: True
  #     MemorySize: 500
  #     Timeout: 800
  
  SendScheduledCampaign:
    Type: AWS::Serverless::Function
    Properties:
      Role: arn:aws:iam::346909834191:role/lambda-execution
      Description: A Lambda function that will trigger campaign sending based on source and schedule provided
      Runtime: nodejs18.x
      Architectures:
        - x86_64
      Handler: src/handlers/send-scheduled-campaign.sendCampaign
      Events:
        CloudWatchEvent:
          Type: Schedule
          Properties:
            Schedule: cron(0/15 * * * ? *)
            Name: send-scheduled-campaign
            Description: Send Scheduled Campaign
            Enabled: True
      MemorySize: 500
      Timeout: 800

  # GetWABAQualityAndStatus:
  #   Type: AWS::Serverless::Function
  #   Properties:
  #     Role: arn:aws:iam::346909834191:role/lambda-execution
  #     Description: A Lambda function that will get WABA quality and status
  #     Runtime: nodejs18.x
  #     Architectures:
  #       - x86_64
  #     Handler: src/handlers/waba-cron.getWABAQualityAndStatus
  #     Events:
  #       CloudWatchEvent:
  #         Type: Schedule
  #         Properties:
  #           Schedule: cron(1 * * * ? *)
  #           Name: waba-cron
  #           Description: Get WABA Quality And Status
  #           Enabled: True
  #     MemorySize: 500
  #     Timeout: 800

  FinishedCampaignNotification:
    Type: AWS::Serverless::Function
    Properties:
      Role: arn:aws:iam::346909834191:role/lambda-execution
      Description: A Lambda function that will send notification when campaign has ended
      Runtime: nodejs18.x
      Architectures:
        - x86_64
      Handler: src/handlers/finished-campaign-notification.sendNotification
      Events:
        CloudWatchEvent:
          Type: Schedule
          Properties:
            Schedule: cron(0/30 * * * ? *)
            Name: finished-campaign-notification
            Description: Send Finished Campaign Notification
            Enabled: True
      MemorySize: 500
      Timeout: 800
  
  # WhatsAppTemplateSync:
  #   Type: AWS::Serverless::Function
  #   Properties:
  #     Role: arn:aws:iam::346909834191:role/lambda-execution
  #     Description: A Lambda function that will sync waba templates
  #     Runtime: nodejs18.x
  #     Architectures:
  #       - x86_64
  #     Handler: src/handlers/whatsapp-template-sync.syncTemplates
  #     Events:
  #       CloudWatchEvent:
  #         Type: Schedule
  #         Properties:
  #           Schedule: cron(0/15 * * * ? *)
  #           Name: whatsapp-template-sync
  #           Description: WhatsApp Template Sync
  #           Enabled: True
  #     MemorySize: 500
  #     Timeout: 800
  
  MindBodySyncUpdatedPackages:
    Type: AWS::Serverless::Function
    Properties:
      Role: arn:aws:iam::346909834191:role/lambda-execution
      Description: A Lambda function that will sync updated mindbody packages
      Runtime: nodejs18.x
      Architectures:
        - x86_64
      Handler: src/handlers/mindbody-package-sync.syncUpdatedPackages
      Events:
        CloudWatchEvent:
          Type: Schedule
          Properties:
            Schedule: cron(0 * * * ? *)
            Name: mindbody-package-sync
            Description: Mindbody Updated Packages Sync
            Enabled: True
      MemorySize: 500
      Timeout: 800

  MindBodyAutomation:
    Type: AWS::Serverless::Function
    Properties:
      Role: arn:aws:iam::346909834191:role/lambda-execution
      Description: A Lambda function that will execute mindbody automation
      Runtime: nodejs18.x
      Architectures:
        - x86_64
      Handler: src/handlers/mindbody-automation.runAutomation
      Events:
        CloudWatchEvent:
          Type: Schedule
          Properties:
            Schedule: cron(0/5 * * * ? *)
            Name: mindbody-automation
            Description: Mindbody Automation
            Enabled: True
      MemorySize: 500
      Timeout: 800
  
  AppSyncCredentialsUpdate:
    Type: AWS::Serverless::Function
    Properties:
      Role: arn:aws:iam::346909834191:role/lambda-execution
      Description: A Lambda function that will execute mindbody automation
      Runtime: nodejs18.x
      Architectures:
        - x86_64
      Handler: src/handlers/appsync-credentials.updateCredentials
      Events:
        CloudWatchEvent:
          Type: Schedule
          Properties:
            Schedule: cron(0 0 1/360 * ? *)
            Name: appsync-credentials
            Description: AppSync Credentials
            Enabled: True
      MemorySize: 500
      Timeout: 800
  
  MindBodyDailyAutomation:
    Type: AWS::Serverless::Function
    Properties:
      Role: arn:aws:iam::346909834191:role/lambda-execution
      Description: A Lambda function that will execute a daily mindbody automation
      Runtime: nodejs18.x
      Architectures:
        - x86_64
      Handler: src/handlers/mindbody-daily-automation.dailyAutomation
      Events:
        CloudWatchEvent:
          Type: Schedule
          Properties:
            Schedule: cron(0 8 * * ? *)
            Name: mindbody-daily-automation
            Description: Mindbody Daily Automation
            Enabled: True
      MemorySize: 500
      Timeout: 800
  
  MindBodyAutomationWebhookCheck:
    Type: AWS::Serverless::Function
    Properties:
      Role: arn:aws:iam::346909834191:role/lambda-execution
      Description: A Lambda function that will execute mindbody automation webhook checking
      Runtime: nodejs18.x
      Architectures:
        - x86_64
      Handler: src/handlers/mindbody-automation-webhook-check.runAutomationWebhookCheck
      Events:
        CloudWatchEvent:
          Type: Schedule
          Properties:
            Schedule: cron(0 * * * ? *)
            Name: mindbody-automation-webhook-check
            Description: Mindbody Automation Webhook Check
            Enabled: True
      MemorySize: 500
      Timeout: 800

  HubSpotFormSync:
    Type: AWS::Serverless::Function
    Properties:
      Role: arn:aws:iam::346909834191:role/lambda-execution
      Description: A Lambda function that will sync agency hubspot form sync
      Runtime: nodejs18.x
      Architectures:
        - x86_64
      Handler: src/handlers/hubspot-form-sync.syncForms
      Events:
        CloudWatchEvent:
          Type: Schedule
          Properties:
            Schedule: cron(0/15 * * * ? *)
            Name: hubspot-form-sync
            Description: HubSpot Form Sync
            Enabled: True
      MemorySize: 500
      Timeout: 800
  
  HubSpotAutomation:
    Type: AWS::Serverless::Function
    Properties:
      Role: arn:aws:iam::346909834191:role/lambda-execution
      Description: A Lambda function that will check if recipient responded to the initial automation in 24hrs
      Runtime: nodejs18.x
      Architectures:
        - x86_64
      Handler: src/handlers/hubspot-automation.runAutomationResponseCheck
      Events:
        CloudWatchEvent:
          Type: Schedule
          Properties:
            Schedule: cron(0 * * * ? *)
            Name: hubspot-automation
            Description: HubSpot Automation
            Enabled: True
      MemorySize: 500
      Timeout: 800

  AppointmentBookingReminder:
    Type: AWS::Serverless::Function
    Properties:
      Role: arn:aws:iam::346909834191:role/lambda-execution
      Description: A Lambda function that will send the appointment booking reminder
      Runtime: nodejs18.x
      Architectures:
        - x86_64
      Handler: src/handlers/appointment-booking-reminder.sendAppointmentBookingReminder
      Events:
        CloudWatchEvent:
          Type: Schedule
          Properties:
            Schedule: cron(0 * * * ? *)
            Name: appointment-booking-reminder
            Description: Send Appointment Booking Reminder
            Enabled: True
      MemorySize: 500
      Timeout: 800

  ReceiveMessageWebhook:
    Type: AWS::Serverless::Function
    Properties:
      Role: arn:aws:iam::346909834191:role/lambda-execution
      Description: A Lambda function that will receive Message Webhook Payload Data from UIB
      Runtime: nodejs18.x
      Architectures:
        - x86_64
      Handler: src/handlers/message-webhook.receivePayload
      Events:
        Api:
          Type: HttpApi
          Properties:
            Path: /message/webhook
            Method: post
            ApiId: !Ref ChaaatHTTPAPI
      MemorySize: 500
      Timeout: 800
  
  ReceiveStripeWebhook:
    Type: AWS::Serverless::Function
    Properties:
      Role: arn:aws:iam::346909834191:role/lambda-execution
      Description: A Lambda function that will receive Stripe Webhook Payload Data
      Runtime: nodejs18.x
      Architectures:
        - x86_64
      Handler: src/handlers/stripe-webhook.receivePayload
      Events:
        Api:
          Type: HttpApi
          Properties:
            Path: /stripe/webhook
            Method: post
            ApiId: !Ref ChaaatHTTPAPI
      MemorySize: 500
      Timeout: 800
      VpcConfig:
        SecurityGroupIds:
          - sg-07a28df38b5835ac2
        SubnetIds:
          - subnet-00b81d6f1726d94b4
          - subnet-0faea7e00b51ac2ac

  ReceiveWixWebhook:
    Type: AWS::Serverless::Function
    Properties:
      Role: arn:aws:iam::346909834191:role/lambda-execution
      Description: A Lambda function that will receive Wix Webhook Payload Data
      Runtime: nodejs18.x
      Architectures:
        - x86_64
      Handler: src/handlers/wix-webhook.receivePayload
      Events:
        Api:
          Type: HttpApi
          Properties:
            Path: /wix/webhook
            Method: post
            ApiId: !Ref ChaaatHTTPAPI
      MemorySize: 500
      Timeout: 800
  
  ReceiveDealzStripeWebhook:
    Type: AWS::Serverless::Function
    Properties:
      Role: arn:aws:iam::346909834191:role/lambda-execution
      Description: A Lambda function that will receive Dealz Stripe Webhook Payload Data
      Runtime: nodejs18.x
      Architectures:
        - x86_64
      Handler: src/handlers/dealz-cron.handleDealzStripeWebhook
      Events:
        Api:
          Type: HttpApi
          Properties:
            Path: /dealz/stripe/webhook
            Method: post
            ApiId: !Ref ChaaatHTTPAPI
      MemorySize: 500
      Timeout: 800